<!--
  WANT - A build management tool.                                 
  Copyright (c) 2001-2003 Juancarlo Anez, Caracas, Venezuela.          
  All rights reserved.
  

  This library is free software; you can redistribute it and/or
  modify it under the terms of the GNU Lesser General Public
  License as published by the Free Software Foundation; either
  version 2.1 of the License, or (at your option) any later version.
  
  This library is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
  Lesser General Public License for more details.
  
  You should have received a copy of the GNU Lesser General Public
  License along with this library; if not, write to the Free Software
  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

{ $Id: want.xml,v 1.83 2004/05/29 17:23:09 juanco Exp $ }

This is the Want script for building Want.
See http://www.suigeneris.org/want/ for details.
-->
<project name="FPUpdater" basedir="." default="release">
	<property name="old.version" value="?{release.ini:releases:current}"/>
	<regexp property="old.build" text="${old.version}" pattern="^.*\.([0-9]+)$" subst="\1"/>
	<property name="build" value="={${old.build}}"/>
	<regexp property="version" text="${old.version}" pattern="\.[0-9]*$" subst=".${build}"/>
	<regexp property="comma.version" pattern="\." subst="," text="${version}"/>
	<regexp property="version2" pattern="^[0-9]*\.[0-9]*" text="${version}"/>
	<tstamp>
		<format property="when" pattern="yyyy,mm,dd,HH,nn,ss"/>
		<format property="date.tag" pattern="yyyy-mm-dd"/>
	</tstamp>
	<property name="basepath" value=""/>
	<regexp property="basepath" text="${basedir}" pattern="^\/" subst=""/>
	<property name="src" value="${basepath}/src"/>
	<property name="test" value="${basepath}/test"/>
	<property name="setup" value="${basepath}/setup"/>
    <property name="brcc" value="${setup}/util/brcc32.exe" />
	<property name="FPUpdater" value="${src}/FPUpdater"/>
	<target name="prepare">
		<echo message="version=${version}"/>
		<echo message="build=${build}"/>
		<delete dir="${src}">
			<include name="**/*.dcu"/>
			<include name="**/*.exe"/>
			<include name="**/*.rsm"/>
			<include name="**/*.dsm"/>
			<include name="**/*.log"/>
			<include name="**/*.~*"/>
			<include name="**/*.bak"/>
		</delete>
	</target>
	<target name="clean">
		<delete dir="${dcu}">
			<include name="*.dcu"/>
		</delete>
		<delete dir="${bin}">
			<include name="*.exe"/>
		</delete>
		<delete dir="${basedir}">
			<include name="*.exe"/>
		</delete>
	</target>
	<target name="finalclean">
  </target>
	<!-- ***** Compile FPUpdater ***** -->
	<target name="Compile-FPUpdater" depends="prepare">
		<delete dir="${dcu}">
			<include name="*.dcu"/>
		</delete>
        <echo input="${FPUpdater}/FPUpdater.rt" file="${FPUpdater}/FPUpdater.rc" />
        <exec executable="${brcc}">
            <arg value="${FPUpdater}/FPUpdater.rc" />
        </exec>        
		<exec executable="msbuild.exe">
            <arg value="/clp:ErrorsOnly /t:Build  ${FPUpdater}/FPUpdater.dproj /p:Platform=Win32 /p:Config=Release /p:DCC_ExeOutput=${setup}/Bin/Win32" />
        </exec>
        <exec executable="msbuild.exe">
            <arg value="/clp:ErrorsOnly /t:Build  ${FPUpdater}/FPUpdater.dproj /p:Platform=Win64 /p:Config=Release /p:DCC_ExeOutput=${setup}/Bin/Win64" />
        </exec>
	</target>

    <target name="setup32">
        <property name="Architecture" value="" />
        <property name="Arch" value="Win32" />
        <property name="Archbit" value="32bit" />
        <property name="Arch2" value="(32-bit)" />
        <echo input="${setup}/setup_template.iss" file="${setup}/setup.iss" />
        <exec basedir="${setup}" executable="iscc">
			<arg value="${setup}/Setup.iss"/>
			<arg value="/Q"/>
        </exec>
        <move tofile="${basepath}/FPUpdater_${version2}_${build}_x32.exe">
            <include name="${setup}/setup.exe" />
        </move>
        <delete file="${setup}/setup.iss" />
    </target>
	
    <target name="setup64">
        <property name="Architecture" value="ArchitecturesInstallIn64BitMode=x64" />
        <property name="Arch" value="Win64" />
        <property name="Archbit" value="64bit" />
        <property name="Arch2" value="(64-bit)" />
        <echo input="${setup}/setup_template.iss" file="${setup}/setup.iss" />
        <exec basedir="${setup}" executable="iscc">
            <arg value="Setup.iss" />
            <arg value="/Q" />
        </exec>
        <move tofile="${basepath}/FPUpdater_${version2}_${build}_x64.exe">
            <include name="${setup}/setup.exe" />
        </move>
        <delete file="${setup}/setup.iss" />
    </target>

	<target name="build">
		<ini file="release.ini">
			<write section="releases" key="current" value="${version}"/>
			<write section="releases" key="last_date" value="${date.tag}"/>
		</ini>
	</target>
	<target name="compile" depends="Compile-FPUpdater"/>
	<target name="release" depends="clean,prepare,compile,setup32,setup64,finalclean"/>
</project>
